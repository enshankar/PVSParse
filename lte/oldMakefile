# Check for PVS_HOME environment variable.
ifeq ($(PVS_HOME),)
    $(error PVS_HOME is not set. Please set this environment variable.)
endif

TARGETS := bsparsestr bsparsenum dfa jsondata_interface

# --- Target-Specific Source Files ---

jsondata_interface_SRCS := \
    identity_uint8_c.c \
    arrayCount_c.c \
    bsparsenum_c.c \
    jsondata_c.c \
	jsonnumber_c.c \
    ltedfapeg_c.c \
    jsondata_interface_c.c \
    ltedfapegproof_c.c \
    ltedfapegtest_c.c \
    dfa_c.c \
    jsondata_interface.c

bsparsestr_SRCS := \
    bsparsestr_c.c \
    bsparsestr.c

bsparsenum_SRCS := \
    bsparsenum_c.c \
    bsparsenum.c

dfa_SRCS := \
    dfa_c.c \
    dfa.c

# --- Global Build Settings ---

CC       := cc
CFLAGS   := -g -w -I$(PVS_HOME)/lib/pvs2c/include
LDFLAGS  := -L$(PVS_HOME)/lib/pvs2c/lib
LDLIBS   := -lgmp -lpvs-prelude

UNAME_S := $(shell uname -s)
ifeq ($(UNAME_S),Darwin)
    LIB_PATH_VAR := DYLD_LIBRARY_PATH
else
    LIB_PATH_VAR := LD_LIBRARY_PATH
endif
LIB_DIR := $(PVS_HOME)/lib/pvs2c/lib

# --- Generic Rules (Automation) ---

# This section automatically generates the necessary build rules for each target.
# You shouldn't need to edit anything below this line.

# Template for creating build and run rules for a target
define TARGET_template
$(1)_OBJS := $$($(1)_SRCS:.c=.o)

$(1).out: $$($(1)_OBJS)
	$(CC) $(LDFLAGS) $$^ -o $$@ $(LDLIBS)

run-$(1): $(1).out
	$(LIB_PATH_VAR)=$(LIB_DIR) ./$$<
endef

# Generate the specific rules for each target defined in the TARGETS list
$(foreach target,$(basename $(TARGETS)),$(eval $(call TARGET_template,$(target))))

%.o: %.c
	$(CC) $(CFLAGS) -c $< -o $@

# --- Main Commands ---

.DEFAULT_GOAL := all
all: $(TARGETS)

clean:
	rm -f *.o *.out *_c.c *_c.h

.PHONY: all clean $(foreach target,$(basename $(TARGETS)),run-$(target))
